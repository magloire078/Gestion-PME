{
  "entities": {
    "Company": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Company",
      "type": "object",
      "description": "Represents a company using the Gestion PME application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the company."
        },
        "name": {
          "type": "string",
          "description": "Name of the company."
        },
        "creationDate": {
          "type": "string",
          "description": "Date the company was created within the system.",
          "format": "date-time"
        },
        "address": {
          "type": "string",
          "description": "Physical address of the company."
        },
        "phone": {
          "type": "string",
          "description": "Contact phone number for the company."
        },
        "contactEmail": {
          "type": "string",
          "description": "Public contact email for the company.",
          "format": "email"
        },
        "taxId": {
          "type": "string",
          "description": "Tax identification number for the company."
        }
      },
      "required": [
        "id",
        "name",
        "creationDate"
      ]
    },
    "Client": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Client",
      "type": "object",
      "description": "Represents a client of the company.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the client."
        },
        "companyId": {
          "type": "string",
          "description": "Reference to Company. (Relationship: Company 1:N Client)"
        },
        "name": {
          "type": "string",
          "description": "Name of the client."
        },
        "email": {
          "type": "string",
          "description": "Email of the client.",
          "format": "email"
        }
      },
      "required": [
        "id",
        "companyId",
        "name"
      ]
    },
    "Invoice": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Invoice",
      "type": "object",
      "description": "Represents an invoice generated by the company.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the invoice."
        },
        "companyId": {
          "type": "string",
          "description": "Reference to Company. (Relationship: Company 1:N Invoice)"
        },
        "clientId": {
          "type": "string",
          "description": "Reference to Client. (Relationship: Client 1:N Invoice)"
        },
        "clientName": {
          "type": "string",
          "description": "Denormalized name of the client for display purposes."
        },
        "invoiceNumber": {
          "type": "string",
          "description": "Invoice number (e.g., INV-2024-001)."
        },
        "issueDate": {
          "type": "string",
          "description": "Date the invoice was issued.",
          "format": "date-time"
        },
        "dueDate": {
          "type": "string",
          "description": "Date the invoice is due.",
          "format": "date-time"
        },
        "amount": {
          "type": "number",
          "description": "Total amount of the invoice."
        },
        "status": {
          "type": "string",
          "description": "Status of the invoice (e.g., Paid, Unpaid, Overdue)."
        }
      },
      "required": [
        "id",
        "companyId",
        "clientId",
        "clientName",
        "invoiceNumber",
        "issueDate",
        "dueDate",
        "amount",
        "status"
      ]
    },
    "Expense": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Expense",
      "type": "object",
      "description": "Represents an expense incurred by the company.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the expense."
        },
        "companyId": {
          "type": "string",
          "description": "Reference to Company. (Relationship: Company 1:N Expense)"
        },
        "date": {
          "type": "string",
          "description": "Date the expense was incurred.",
          "format": "date-time"
        },
        "category": {
          "type": "string",
          "description": "Category of the expense (e.g., Rent, Utilities, Supplies)."
        },
        "amount": {
          "type": "number",
          "description": "Amount of the expense."
        },
        "description": {
          "type": "string",
          "description": "Description of the expense."
        },
        "receiptUrl": {
            "type": "string",
            "description": "URL of the uploaded receipt in Firebase Storage.",
            "format": "uri"
        }
      },
      "required": [
        "id",
        "companyId",
        "date",
        "category",
        "amount",
        "description"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/companies/{companyId}",
        "definition": {
          "entityName": "Company",
          "schema": {
            "$ref": "#/backend/entities/Company"
          },
          "description": "Stores company data. Path-based ownership: only the company owner (identified via `request.auth.uid` matching the `companyId`) can manage this document.",
          "params": [
            {
              "name": "companyId",
              "description": "Unique identifier for the company."
            }
          ]
        }
      },
      {
        "path": "/companies/{companyId}/clients/{clientId}",
        "definition": {
          "entityName": "Client",
          "schema": {
            "$ref": "#/backend/entities/Client"
          },
          "description": "Stores client data associated with a specific company.",
          "params": [
            {
              "name": "companyId",
              "description": "Unique identifier for the company."
            },
            {
              "name": "clientId",
              "description": "Unique identifier for the client."
            }
          ]
        }
      },
      {
        "path": "/companies/{companyId}/invoices/{invoiceId}",
        "definition": {
          "entityName": "Invoice",
          "schema": {
            "$ref": "#/backend/entities/Invoice"
          },
          "description": "Stores invoice data associated with a specific company. Includes denormalized `companyId` for authorization independence.",
          "params": [
            {
              "name": "companyId",
              "description": "Unique identifier for the company."
            },
            {
              "name": "invoiceId",
              "description": "Unique identifier for the invoice."
            }
          ]
        }
      },
      {
        "path": "/companies/{companyId}/expenses/{expenseId}",
        "definition": {
          "entityName": "Expense",
          "schema": {
            "$ref": "#/backend/entities/Expense"
          },
          "description": "Stores expense data associated with a specific company. Includes denormalized `companyId` for authorization independence.",
          "params": [
            {
              "name": "companyId",
              "description": "Unique identifier for the company."
            },
            {
              "name": "expenseId",
              "description": "Unique identifier for the expense."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to ensure authorization independence, clarity, and scalability for the Gestion PME application.  Companies are stored under a top-level `companies` collection. Invoices and Expenses are stored as subcollections under each company. This design promotes data locality and simplifies querying for company-specific data.  Authorization independence is achieved by leveraging path-based ownership for Company data and ensuring that invoice and expenses data contain redundant authorization data (the `companyId`) to avoid `get()` calls in security rules. This strategy directly addresses Authorization Independence. The DBAC is achieved since access is controlled by `request.auth.uid` and the path structure, removing the need for custom claims.  QAPs (Rules are not Filters) are inherently supported due to path-based ownership. List operations can be secured by scoping queries to the user's company.  Finally, the structure allows simple enforcement of data integrity using security rules for ownership, timestamps, and other invariants. The design adheres to structural segregation by keeping the company-owned data separate under each company document."
  }
}
